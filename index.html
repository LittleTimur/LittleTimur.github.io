<!doctype html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —à—É–º–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏</title><script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.5.2/dist/speech-commands.min.js"></script><style>* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 520px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            background: #f5f5f5;
        }

        .status.recording {
            background: #ffebee;
            color: #c62828;
        }

        .status.idle {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sound-level-container {
            margin: 30px 0;
        }

        .sound-level-label {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .sound-level-value {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .sound-level-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .sound-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #ffeb3b 50%, #f44336 100%);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 15px;
        }

        .has-sound-indicator {
            text-align: center;
            margin: 20px 0;
            font-size: 16px;
            font-weight: bold;
        }

        .has-sound-indicator.active {
            color: #4caf50;
        }

        .has-sound-indicator.inactive {
            color: #999;
        }

        .settings {
            margin-top: 20px;
            padding: 12px 16px;
            border-radius: 12px;
            background: #f7f7ff;
            border: 1px solid #e0e0ff;
            font-size: 14px;
        }

        .settings-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
        }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .settings-row label {
            flex: 1;
            color: #555;
        }

        .settings-row input[type="number"] {
            width: 90px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .settings-hint {
            font-size: 12px;
            color: #777;
            margin-bottom: 8px;
        }

        .settings button {
            width: 100%;
            margin-top: 4px;
            padding: 8px 10px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-start {
            background: #4caf50;
            color: white;
        }

        .btn-start:hover {
            background: #45a049;
        }

        .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #f44336;
            color: white;
        }

        .btn-stop:hover {
            background: #da190b;
        }

        .btn-stop:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .wave-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            height: 60px;
            margin: 20px 0;
        }

        .wave-bar {
            width: 4px;
            background: #667eea;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 20px; }
            50% { height: 60px; }
        }

        .wave-animation.hidden {
            display: none;
        }</style><script defer="defer" src="/index.js"></script></head><body><div class="container"><h1>üé§ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —à—É–º–∞</h1><div class="status idle" id="status">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏</div><div class="sound-level-container"><div class="sound-level-label">–£—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞</div><div class="sound-level-value" id="soundLevel">0</div><div class="sound-level-bar"><div class="sound-level-fill" id="soundLevelFill"></div></div></div><div class="has-sound-indicator inactive" id="hasSoundIndicator">üîá –ù–µ—Ç –∑–≤—É–∫–∞</div><div class="settings"><div class="settings-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —à—É–º–∞</div><div class="settings-row"><label for="thresholdInput">–ü–æ—Ä–æ–≥ —É—Ä–æ–≤–Ω—è —à—É–º–∞ (0‚Äì255):</label> <input id="thresholdInput" type="number" min="0" max="255" step="1"/></div><div class="settings-row"><label for="silenceTimeoutInput">–¢–∞–π–º–∞—É—Ç —Ç–∏—à–∏–Ω—ã (–º—Å, –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å):</label> <input id="silenceTimeoutInput" type="number" min="100" step="100"/></div><div class="settings-hint">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Ä–æ–≥ = 30, —Ç–∞–π–º–∞—É—Ç = 3000 –º—Å (3 —Å–µ–∫—É–Ω–¥—ã).</div><button class="btn-start" type="button" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button></div><div class="wave-animation hidden" id="waveAnimation"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div><div class="button-group"><button class="btn-start" id="btnStart" onclick="startRecording()">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button> <button class="btn-stop" id="btnStop" onclick="stopRecording()" disabled="disabled">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button></div><div class="error" id="error"></div><div id="info"></div></div><script>const DEFAULT_THRESHOLD = 30;
    const DEFAULT_SILENCE_TIMEOUT = 3000;

    let THRESHOLD = DEFAULT_THRESHOLD;
    let SILENCE_TIMEOUT = DEFAULT_SILENCE_TIMEOUT;

    let audioContext = null;
    let analyser = null;
    let stream = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let isListening = false;
    let playbackAudio = null;

    let tfModel = null;
    let tfListener = null;
    let isPlaybackInterruptible = false;

    let soundLevel = 0;
    let hasSound = false;
    let lastSoundTime = Date.now();

    function getUserMedia(constraints) {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            return navigator.mediaDevices.getUserMedia(constraints);
        }
        const getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) {
            return Promise.reject(new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –∏–ª–∏ localhost.'));
        }
        return new Promise((resolve, reject) => {
            getUserMedia.call(navigator, constraints, resolve, reject);
        });
    }

    function showError(message) {
        const errorEl = document.getElementById('error');
        errorEl.textContent = message;
        errorEl.classList.add('show');
        setTimeout(() => errorEl.classList.remove('show'), 5000);
    }

    async function startInterruptionListener() {
        if (isPlaybackInterruptible) {
            return;
        }

        if (typeof speechCommands === 'undefined') {
            console.error('speechCommands –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω');
            showError('–ú–æ–¥–µ–ª—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            startSimpleInterruption();
            return;
        }

        try {
            if (!tfModel) {
                document.getElementById('info').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...';
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º Speech Commands –º–æ–¥–µ–ª—å...');
                tfModel = await speechCommands.create('BROWSER_FFT');
            }

            isPlaybackInterruptible = true;
            document.getElementById('info').textContent = '–°–ª—É—à–∞—é –∫–æ–º–∞–Ω–¥—É "stop"...';

            tfModel.listen(result => {
                if (!isPlaybackInterruptible) return;

                const labels = tfModel.wordLabels();
                const stopIndex = labels.indexOf('stop');
                if (stopIndex === -1) return;

                const confidence = result.scores[stopIndex];
                console.log(`"stop" confidence: ${confidence.toFixed(3)}`);

                if (confidence > 0.75) {
                    console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: STOP');
                    document.getElementById('info').textContent = '–ö–æ–º–∞–Ω–¥–∞ "stop" –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!';
                    stopAnyPlayback();
                    isPlaybackInterruptible = false;
                }
            }, {
                probabilityThreshold: 0.75,
                invokeCallbackOnNoise: true
            });

        } catch (err) {
            console.error('TF.js –æ—à–∏–±–∫–∞:', err);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏: ' + err.message);
            startSimpleInterruption();
        }
    }

    function stopInterruptionListener() {
        if (tfModel && isPlaybackInterruptible) {
            tfModel.stopListening();
        }
        isPlaybackInterruptible = false;
    }

    function startSimpleInterruption() {
        if (!analyser) return;
        const check = () => {
            if (!isPlaybackInterruptible || !playbackAudio || playbackAudio.paused) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            const avg = Math.round(dataArray.reduce((a, b) => a + b, 0) / dataArray.length);
            if (avg > THRESHOLD) {
                console.log('–ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ –∑–≤—É–∫—É');
                stopAnyPlayback();
                isPlaybackInterruptible = false;
            } else {
                requestAnimationFrame(check);
            }
        };
        check();
    }

    function updateUI() {
        const statusEl = document.getElementById('status');
        const soundLevelEl = document.getElementById('soundLevel');
        const soundLevelFillEl = document.getElementById('soundLevelFill');
        const hasSoundIndicatorEl = document.getElementById('hasSoundIndicator');
        const waveAnimationEl = document.getElementById('waveAnimation');

        if (isRecording) {
            statusEl.textContent = '–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...';
            statusEl.className = 'status recording';
            waveAnimationEl.classList.remove('hidden');
        } else if (playbackAudio && !playbackAudio.paused) {
            statusEl.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...';
            statusEl.className = 'status idle';
            waveAnimationEl.classList.add('hidden');
        } else if (isListening) {
            statusEl.textContent = '–°–ª—É—à–∞—é... –ì–æ–≤–æ—Ä–∏—Ç–µ';
            statusEl.className = 'status idle';
            waveAnimationEl.classList.add('hidden');
        } else {
            statusEl.textContent = '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø–∏—Å–∏';
            statusEl.className = 'status idle';
            waveAnimationEl.classList.add('hidden');
        }

        soundLevelEl.textContent = soundLevel;
        const percentage = Math.min((soundLevel / 255) * 100, 100);
        soundLevelFillEl.style.width = percentage + '%';

        if (hasSound) {
            hasSoundIndicatorEl.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–≤—É–∫';
            hasSoundIndicatorEl.className = 'has-sound-indicator active';
        } else {
            hasSoundIndicatorEl.textContent = '–ù–µ—Ç –∑–≤—É–∫–∞';
            hasSoundIndicatorEl.className = 'has-sound-indicator inactive';
        }
    }

    function stopAnyPlayback() {
        if (playbackAudio && !playbackAudio.paused) {
            playbackAudio.pause();
            playbackAudio.currentTime = 0;
        }
        stopInterruptionListener();

        isRecording = false;
        isListening = true;
        updateUI();
        requestAnimationFrame(checkSoundLoop);
    }

    function startRecording() {
        if (isRecording) return;

        console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å');
        const infoEl = document.getElementById('info');
        infoEl.textContent = '–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å';
        isRecording = true;
        audioChunks = [];

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm; codecs=opus' });
            console.log('–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Ä–∞–∑–º–µ—Ä:', audioBlob.size, '–±–∞–π—Ç');
            infoEl.textContent = '–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞';

            if (playbackAudio) {
                URL.revokeObjectURL(playbackAudio.src);
            }

            const url = URL.createObjectURL(audioBlob);
            playbackAudio = new Audio(url);
            playbackAudio.onended = () => {
                URL.revokeObjectURL(url);
                stopAnyPlayback();
            };

            playbackAudio.play().catch(e => {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏:', e);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ');
                stopAnyPlayback();
            });

            startInterruptionListener();
        };

        mediaRecorder.start();
        updateUI();
    }

    function stopRecording() {
        if (!isRecording) return;

        console.log('–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å');
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        isRecording = false;
        updateUI();
    }

    /**
     * –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫–∞:
     * - –∏–∑–º–µ—Ä—è–µ—Ç —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å,
     * - –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞,
     * - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ç–∏—à–∏–Ω—ã.
     */
    function checkSoundLoop() {
        if (!isListening || (playbackAudio && !playbackAudio.paused)) {
            return;
        }

        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        const avg = Math.round(dataArray.reduce((a, b) => a + b, 0) / dataArray.length);
        soundLevel = avg;
        const isAboveThreshold = avg > THRESHOLD;

        if (isAboveThreshold) {
            lastSoundTime = Date.now();
        }

        if (!isRecording && isAboveThreshold) {
            stopAnyPlayback();
            startRecording();
        }

        if (isRecording) {
            const silenceDuration = Date.now() - lastSoundTime;
            if (silenceDuration >= SILENCE_TIMEOUT) {
                stopRecording();
            }
        }

        hasSound = isAboveThreshold;
        updateUI();

        requestAnimationFrame(checkSoundLoop);
    }

    function setupAudioAnalyzer(stream) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;

        const microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);

        isListening = true;
        lastSoundTime = Date.now();
        checkSoundLoop();
    }


    function initSettingsUI() {
        const thresholdInput = document.getElementById('thresholdInput');
        const silenceTimeoutInput = document.getElementById('silenceTimeoutInput');

        thresholdInput.value = THRESHOLD;
        silenceTimeoutInput.value = SILENCE_TIMEOUT;
    }

    function saveSettings() {
        const thresholdInput = document.getElementById('thresholdInput');
        const silenceTimeoutInput = document.getElementById('silenceTimeoutInput');
        const infoEl = document.getElementById('info');

        const parsedThreshold = Number(thresholdInput.value);
        const parsedTimeout = Number(silenceTimeoutInput.value);

        if (Number.isNaN(parsedThreshold) || parsedThreshold < 0 || parsedThreshold > 255) {
            showError('–ü–æ—Ä–æ–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 255');
            thresholdInput.value = THRESHOLD;
            return;
        }

        if (Number.isNaN(parsedTimeout) || parsedTimeout <= 0) {
            showError('–¢–∞–π–º–∞—É—Ç —Ç–∏—à–∏–Ω—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º (–≤ –º—Å)');
            silenceTimeoutInput.value = SILENCE_TIMEOUT;
            return;
        }

        THRESHOLD = parsedThreshold;
        SILENCE_TIMEOUT = parsedTimeout;

        infoEl.textContent = `–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: –ø–æ—Ä–æ–≥ = ${THRESHOLD}, —Ç–∞–π–º–∞—É—Ç —Ç–∏—à–∏–Ω—ã = ${SILENCE_TIMEOUT} –º—Å`;
        console.log('–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', { THRESHOLD, SILENCE_TIMEOUT });
    }


    async function init() {
        try {
            document.querySelector('.button-group').style.display = 'none';

            stream = await getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            setupAudioAnalyzer(stream);
            updateUI();
            initSettingsUI();
        } catch (err) {
            showError('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
            console.error(err);
        }
    }

    window.addEventListener('DOMContentLoaded', init);

    window.addEventListener('beforeunload', () => {
        if (stream) stream.getTracks().forEach(t => t.stop());
        if (audioContext) audioContext.close();
        if (playbackAudio) {
            URL.revokeObjectURL(playbackAudio.src);
        }
        stopInterruptionListener();
    });</script></body></html>